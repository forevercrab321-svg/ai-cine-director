<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supabase å¿«é€Ÿä¿®å¤</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .content {
      padding: 40px;
    }
    
    .step {
      margin-bottom: 40px;
      padding: 25px;
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      border-radius: 8px;
    }
    
    .step h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.5em;
    }
    
    .sql-box {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.95em;
      line-height: 1.5;
      overflow-x: auto;
      margin: 15px 0;
      position: relative;
      max-height: 500px;
      overflow-y: auto;
    }
    
    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background 0.3s;
      z-index: 10;
    }
    
    .copy-btn:hover {
      background: #764ba2;
    }
    
    .copy-btn.copied {
      background: #4caf50;
    }
    
    .instructions {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      line-height: 1.8;
    }
    
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4caf50;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      color: #2e7d32;
    }
    
    .warning {
      background: #fff3e0;
      border-left: 4px solid #ff9800;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
      color: #e65100;
    }
    
    .link {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }
    
    .link:hover {
      text-decoration: underline;
    }
    
    .checklist {
      list-style: none;
      margin: 15px 0;
    }
    
    .checklist li {
      padding: 8px 0;
      padding-left: 30px;
      position: relative;
    }
    
    .checklist li:before {
      content: "â˜";
      position: absolute;
      left: 0;
      color: #667eea;
      font-weight: bold;
    }
    
    .footer {
      background: #f8f9fa;
      padding: 20px;
      text-align: center;
      color: #666;
      border-top: 1px solid #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ Supabase å¿«é€Ÿä¿®å¤</h1>
      <p>ä¿®å¤ RLS ç­–ç•¥å’Œ Triggerï¼Œè®©åº”ç”¨å®Œå…¨æ­£å¸¸å·¥ä½œï¼ˆ5åˆ†é’Ÿï¼‰</p>
    </div>
    
    <div class="content">
      <!-- è¯Šæ–­ç»“æœ -->
      <div class="step">
        <h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>
        <div class="success">
          <strong>âœ… å·²ç»å®Œæˆ:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>ç¯å¢ƒå˜é‡å·²é…ç½®</li>
            <li>Supabase API è¿æ¥æ­£å¸¸</li>
            <li>æ•°æ®åº“è¡¨å·²åˆ›å»º (profiles, storyboards, scenes)</li>
          </ul>
        </div>
        <div class="warning">
          <strong>âš ï¸ éœ€è¦ä¿®å¤:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>RLS ç­–ç•¥æœªé…ç½®ï¼ˆæ‰€æœ‰ç”¨æˆ·å¯èƒ½çœ‹åˆ°å½¼æ­¤çš„æ•°æ®ï¼‰</li>
            <li>Trigger æœªåˆ›å»ºï¼ˆæ–°ç”¨æˆ·æ³¨å†Œåæ²¡æœ‰è‡ªåŠ¨ profileï¼‰</li>
          </ul>
        </div>
      </div>
      
      <!-- Step 1 -->
      <div class="step">
        <h2>Step 1ï¸âƒ£: æ‰“å¼€ Supabase SQL Editor</h2>
        <div class="instructions">
          <p>è®¿é—®ä»¥ä¸‹é“¾æ¥ï¼š</p>
          <p><a href="https://app.supabase.com/project/gtxgkdsayswonlewqfzj/sql" target="_blank" class="link">
            https://app.supabase.com/project/gtxgkdsayswonlewqfzj/sql
          </a></p>
          <p style="margin-top: 10px;">åœ¨å·¦ä¾§ "SQL" èœå•ä¸­ï¼Œç‚¹å‡» "New Query" åˆ›å»ºæ–°æŸ¥è¯¢</p>
        </div>
      </div>
      
      <!-- Step 2 -->
      <div class="step">
        <h2>Step 2ï¸âƒ£: å¤åˆ¶å¹¶è¿è¡Œ SQL è„šæœ¬</h2>
        <div class="instructions">
          <p>ç‚¹å‡»ä¸‹é¢çš„ "å¤åˆ¶" æŒ‰é’®ï¼Œå°†æ‰€æœ‰ SQL ä»£ç å¤åˆ¶åˆ° Supabase SQL Editorï¼Œç„¶åç‚¹å‡» "Run" è¿è¡Œã€‚</p>
        </div>
        
        <div class="sql-box" id="sqlCode">-- ====================================================================
-- 1. åˆ›å»º Profiles RLS ç­–ç•¥
-- ====================================================================

DROP POLICY IF EXISTS "Public profiles are viewable by everyone." ON public.profiles;
DROP POLICY IF EXISTS "Users can insert their own profile." ON public.profiles;
DROP POLICY IF EXISTS "Users can update own profile." ON public.profiles;

CREATE POLICY "Users can view their own profile"
  ON profiles FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can insert their own profile"
  ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile"
  ON profiles FOR UPDATE USING (auth.uid() = id);

CREATE POLICY "Service role can access all profiles"
  ON profiles USING (auth.role() = 'service_role');

-- ====================================================================
-- 2. åˆ›å»º Triggerï¼ˆæ–°ç”¨æˆ·è‡ªåŠ¨åˆ›å»º Profileï¼‰
-- ====================================================================

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER
LANGUAGE PLPGSQL
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.profiles (id, name, credits)
  VALUES (new.id, COALESCE(new.raw_user_meta_data->>'name', new.email), 50);
  RETURN new;
END;
$$;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();

-- ====================================================================
-- 3. Storyboards RLS ç­–ç•¥
-- ====================================================================

DROP POLICY IF EXISTS "Users can view their own storyboards." ON public.storyboards;
DROP POLICY IF EXISTS "Users can insert their own storyboards." ON public.storyboards;
DROP POLICY IF EXISTS "Users can update their own storyboards." ON public.storyboards;
DROP POLICY IF EXISTS "Users can delete their own storyboards." ON public.storyboards;

CREATE POLICY "Users can view own storyboards" ON storyboards
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert storyboards" ON storyboards
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own storyboards" ON storyboards
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own storyboards" ON storyboards
  FOR DELETE USING (auth.uid() = user_id);

-- ====================================================================
-- 4. Scenes RLS ç­–ç•¥
-- ====================================================================

DROP POLICY IF EXISTS "Users can view scenes from their storyboards." ON public.scenes;
DROP POLICY IF EXISTS "Users can insert scenes to their storyboards." ON public.scenes;
DROP POLICY IF EXISTS "Users can update scenes from their storyboards." ON public.scenes;
DROP POLICY IF EXISTS "Users can delete scenes from their storyboards." ON public.scenes;

CREATE POLICY "Users can view own scenes" ON scenes
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.storyboards 
    WHERE storyboards.id = scenes.storyboard_id AND storyboards.user_id = auth.uid())
  );
CREATE POLICY "Users can insert scenes" ON scenes
  FOR INSERT WITH CHECK (
    EXISTS (SELECT 1 FROM public.storyboards 
    WHERE storyboards.id = storyboard_id AND storyboards.user_id = auth.uid())
  );
CREATE POLICY "Users can update own scenes" ON scenes
  FOR UPDATE USING (
    EXISTS (SELECT 1 FROM public.storyboards 
    WHERE storyboards.id = scenes.storyboard_id AND storyboards.user_id = auth.uid())
  );
CREATE POLICY "Users can delete own scenes" ON scenes
  FOR DELETE USING (
    EXISTS (SELECT 1 FROM public.storyboards 
    WHERE storyboards.id = scenes.storyboard_id AND storyboards.user_id = auth.uid())
  );

-- ====================================================================
-- 5. ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºç¼ºå¤±çš„ Profiles
-- ====================================================================

INSERT INTO public.profiles (id, name, credits)
SELECT u.id, COALESCE(u.raw_user_meta_data->>'name', u.email), 50
FROM auth.users u
WHERE u.id NOT IN (SELECT id FROM public.profiles)
ON CONFLICT (id) DO NOTHING;

-- ====================================================================
-- éªŒè¯
-- ====================================================================

SELECT COUNT(*) as profiles_count FROM public.profiles;
SELECT COUNT(*) as policies_count FROM pg_policies WHERE schemaname = 'public';
        </div>
        <button class="copy-btn" onclick="copySql()">ğŸ“‹ å¤åˆ¶æ‰€æœ‰ SQL</button>
        
        <div class="success">
          <strong>âœ… è¿è¡Œæ­¥éª¤:</strong>
          <ol style="margin-left: 20px; margin-top: 10px;">
            <li>ç‚¹å‡»ä¸Šé¢çš„ "å¤åˆ¶æ‰€æœ‰ SQL" æŒ‰é’®</li>
            <li>ç²˜è´´åˆ° Supabase SQL Editor</li>
            <li>ç‚¹å‡» "Run" æˆ–æŒ‰ Ctrl+Enter è¿è¡Œ</li>
            <li>ç­‰å¾…æ‰§è¡Œå®Œæˆï¼ˆåº”è¯¥æ²¡æœ‰é”™è¯¯ï¼‰</li>
            <li>å…³é—­æ­¤æŸ¥è¯¢</li>
          </ol>
        </div>
      </div>
      
      <!-- Step 3 -->
      <div class="step">
        <h2>Step 3ï¸âƒ£: éªŒè¯ä¿®å¤</h2>
        <div class="instructions">
          <p>æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œè¯Šæ–­è„šæœ¬éªŒè¯æ‰€æœ‰ä¿®å¤å·²æˆåŠŸï¼š</p>
        </div>
        <div class="sql-box">bash /Users/monsterlee/Desktop/ai-cine-director/scripts/diagnose-supabase-complete.sh</div>
        <div class="success">
          <strong>âœ… é¢„æœŸè¾“å‡º:</strong>
          <p style="margin-top: 10px;">åº”è¯¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®éƒ½æ˜¯ âœ… é€šè¿‡</p>
        </div>
      </div>
      
      <!-- Step 4 -->
      <div class="step">
        <h2>Step 4ï¸âƒ£: å¯åŠ¨åº”ç”¨</h2>
        <div class="instructions">
          <p>æ‰“å¼€ç»ˆç«¯ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨åº”ç”¨ï¼š</p>
        </div>
        <div class="sql-box">cd /Users/monsterlee/Desktop/ai-cine-director
npm run dev:all</div>
        <div class="success">
          <p>åº”è¯¥çœ‹åˆ°ï¼š</p>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>âœ… åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:3002</li>
            <li>âœ… å‰ç«¯åº”ç”¨è¿è¡Œåœ¨ http://localhost:3000</li>
          </ul>
        </div>
      </div>
      
      <!-- Step 5 -->
      <div class="step">
        <h2>Step 5ï¸âƒ£: æµ‹è¯•åº”ç”¨</h2>
        <div class="instructions">
          <p>æ‰“å¼€æµè§ˆå™¨è®¿é—® <a href="http://localhost:3000" target="_blank" class="link">http://localhost:3000</a></p>
          <ol style="margin-left: 20px; margin-top: 10px;">
            <li>ç‚¹å‡» "Sign Up" åˆ›å»ºæ–°ç”¨æˆ·</li>
            <li>ä½¿ç”¨ä¸€ä¸ªæ–°çš„é‚®ç®±åœ°å€ï¼ˆä¾‹å¦‚: testuser123@example.comï¼‰</li>
            <li>è¾“å…¥å¯†ç å¹¶æäº¤</li>
            <li>ç™»å½•æˆåŠŸåï¼Œåº”è¯¥çœ‹åˆ° <strong>50 ç§¯åˆ†</strong> âœ…</li>
          </ol>
        </div>
      </div>
      
      <!-- å®Œæˆæ¸…å• -->
      <div class="step">
        <h2>âœ… å®Œæˆæ£€æŸ¥æ¸…å•</h2>
        <ul class="checklist">
          <li>SQL è„šæœ¬åœ¨ Supabase ä¸­æˆåŠŸè¿è¡Œï¼ˆæ— é”™è¯¯ï¼‰</li>
          <li>è¯Šæ–­è„šæœ¬æ˜¾ç¤ºæ‰€æœ‰ âœ… é€šè¿‡</li>
          <li>åº”ç”¨å¯åŠ¨æˆåŠŸï¼ˆnpm run dev:allï¼‰</li>
          <li>èƒ½å¤Ÿæ³¨å†Œæ–°ç”¨æˆ·</li>
          <li>æ–°ç”¨æˆ·è‡ªåŠ¨è·å¾— 50 ç§¯åˆ†</li>
          <li>ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„æ•°æ®ï¼ˆRLS ä¿æŠ¤ï¼‰</li>
        </ul>
      </div>
      
      <!-- æ•…éšœæ’é™¤ -->
      <div class="step">
        <h2>ğŸ”§ æ•…éšœæ’é™¤</h2>
        <div class="warning">
          <strong>é—®é¢˜: "duplicate key value violates unique constraint"</strong>
          <p style="margin-top: 8px;">è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤ºæŸä¸ªç­–ç•¥æˆ– trigger å·²å­˜åœ¨ã€‚ç»§ç»­è¿è¡Œå…¶ä»– SQLã€‚</p>
        </div>
        <div class="warning">
          <strong>é—®é¢˜: "Policy already exists"</strong>
          <p style="margin-top: 8px;">æ­£å¸¸ã€‚DROP POLICY ä¼šå…ˆåˆ é™¤æ—§çš„ç­–ç•¥ã€‚</p>
        </div>
        <div class="warning">
          <strong>é—®é¢˜: æ–°ç”¨æˆ·æ³¨å†Œåè¿˜æ˜¯æ²¡æœ‰ profile</strong>
          <p style="margin-top: 8px;">å¯èƒ½ trigger æ²¡æœ‰åˆ›å»ºæˆåŠŸã€‚æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æ¶ˆæ¯ï¼Œé‡æ–°è¿è¡Œ trigger åˆ›å»ºéƒ¨åˆ†çš„ SQLã€‚</p>
        </div>
      </div>
      
      <!-- å…³äºé‚®ä»¶é…ç½® -->
      <div class="step">
        <h2>ğŸ“§ å…³äº Supabase é‚®ä»¶é…ç½®</h2>
        <div class="success">
          <strong>âœ… å½“å‰çŠ¶æ€:</strong>
          <ul style="margin-left: 20px; margin-top: 10px;">
            <li>Supabase ä½¿ç”¨é»˜è®¤é‚®ä»¶æœåŠ¡ï¼ˆå·²å¯ç”¨ï¼‰</li>
            <li>ä¸éœ€è¦é…ç½®è‡ªå®šä¹‰ SMTP</li>
            <li>"Enable custom SMTP" æ˜¯å¯é€‰çš„</li>
          </ul>
        </div>
        <div class="instructions">
          <p style="margin-top: 15px;"><strong>å¦‚æœä½ çœ‹åˆ° "Enable custom SMTP" è­¦å‘Šï¼š</strong></p>
          <p style="margin-top: 8px;">è¿™åªæ˜¯æç¤ºï¼Œä¸æ˜¯å¿…é¡»çš„ã€‚é™¤éä½ æƒ³ä½¿ç”¨è‡ªå·±çš„é‚®ä»¶æœåŠ¡å™¨ï¼Œå¦åˆ™ä¿æŒé»˜è®¤è®¾ç½®å³å¯ã€‚</p>
        </div>
      </div>
    </div>
    
    <div class="footer">
      <p>AI Cine Director - Supabase å¿«é€Ÿä¿®å¤æŒ‡å—</p>
      <p style="margin-top: 8px; font-size: 0.9em;">ç”Ÿæˆäº 2024-02-23 | é¢„è®¡å®Œæˆæ—¶é—´: 5 åˆ†é’Ÿ</p>
    </div>
  </div>
  
  <script>
    function copySql() {
      const sqlCode = document.getElementById('sqlCode').textContent;
      navigator.clipboard.writeText(sqlCode).then(() => {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ… å·²å¤åˆ¶ï¼';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = originalText;
          btn.classList.remove('copied');
        }, 2000);
      }).catch(err => {
        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      });
    }
  </script>
</body>
</html>