# AI Cine Director - 新功能使用指南

## 🎉 更新内容 (2026年2月23日)

### ✅ 修复的问题

#### 1. **图片生成三视图问题** ✅ 已修复
**问题**：生成的图片都是角色三视图/character sheet，而不是单一场景。

**解决方案**：
- 改进了提示词构建逻辑，场景描述在前，角色描述在后
- 添加了反三视图关键词（"NOT character sheet, NOT turnaround"）
- 强调单一动作场景（"Single cinematic scene only"）

**修改文件**：
- `services/replicateService.ts` - 图片生成提示词
- `server/routes/gemini.ts` - image_prompt 构建逻辑

---

### 🆕 新增功能

#### 1. **批量生成 9 个不同场景** ✅
**功能**：现在可以一次性生成 9 个不同镜头的图片。

**使用方法**：
1. 生成故事板后，进入"制作模式"
2. 使用"批量生成镜头图片"面板
3. 选择每批数量：3、6、9、12
4. 点击"生成首批 N 个镜头图片"

**特点**：
- 每个镜头使用不同的场景描述
- 保持角色一致性（同一角色，不同动作）
- 支持继续生成（严格顺序/跳过失败）
- 实时进度显示

#### 2. **参考图片上传功能** ✅
**功能**：上传角色参考图，AI 自动分析生成角色描述，确保所有场景角色一致。

**使用方法**：
1. 在"故事构思"页面，输入故事创意
2. 点击"上传角色参考图"区域
3. 选择清晰的角色图片（JPG/PNG/WebP，最大 10MB）
4. AI 自动分析并生成角色描述
5. 生成的描述会自动应用到所有场景

**AI 分析内容**：
- 面部特征（五官、肤色）
- 发型和发色
- 服装和配饰
- 艺术风格
- 体型和姿态

**新增组件**：
- `components/ReferenceImageUploader.tsx`

---

## 📖 完整工作流程

### 第一步：创建故事构思
1. 打开应用 http://localhost:3000
2. 使用开发者邮箱登录（无限积分）：`forevercrab321@gmail.com`
3. 输入故事创意，例如：
   ```
   在未来东京，一位赛博朋克快递员猫咪正在送披萨
   ```

### 第二步：上传角色参考图（可选）
1. 点击"上传角色参考图"区域
2. 选择你想要的角色图片
3. 等待 AI 分析（约 5-10 秒）
4. 查看生成的角色描述
5. 如果不满意，可以重新上传

### 第三步：生成故事板
1. 点击"生成故事板"按钮
2. AI 会生成 5 个场景（Gemini 2.0 Flash）
3. 每个场景包含：
   - 视觉描述
   - 音频描述
   - 镜头类型
   - 图片提示词

### 第四步：批量生成图片
1. 进入"制作模式"（自动跳转）
2. 找到"批量生成镜头图片"面板
3. 配置：
   - **每批数量**：3/6/9/12（建议 9）
   - **模型**：Flux 1.1 Pro（高质量）或 Flux Schnell（快速）
4. 点击"生成首批 9 个镜头图片"
5. 等待生成（每张约 10-30 秒）

### 第五步：查看结果
- 实时进度条显示
- 每个镜头的缩略图
- 状态：等待中/生成中/完成/失败
- 成功后自动刷新余额

### 第六步：继续生成（如需要）
- 如果有超过 9 个镜头，点击"继续下一批"
- 选择策略：
  - **严格顺序**：从第一个缺失的镜头开始
  - **跳过失败**：从最后成功的镜头之后开始

---

## 🎨 角色一致性原理

### 旧版问题
```
提示词: "角色描述，场景描述，镜头类型"
结果: 生成三视图（正面、侧面、背面）
```

### 新版修复
```
提示词: "Cinematic [镜头类型]: [场景描述]. Character: [角色描述]. Single scene only."
结果: 单一场景，角色在执行具体动作
```

### 关键改进
1. **场景优先**：场景描述在前，AI 会专注于场景而非角色设计
2. **反三视图**：明确说明"NOT character sheet"
3. **单一动作**：强调"Single scene only"
4. **一致性锁定**：使用角色锚点（character_anchor）

---

## 🔍 示例对比

### ❌ 旧版生成（三视图）
```
East Asian male, early 20s, red silk scarf, golden armor plates.
Standing confidently. Photorealistic style.
```
**结果**：生成同一个角色的 3 个视角（正面、侧面、背面）

### ✅ 新版生成（单一场景）
```
Cinematic medium shot: East Asian male warrior stands on a battlefield, 
holding a golden spear, red scarf flowing in wind, golden armor glowing.
Character: East Asian male, early 20s, red silk scarf, golden armor plates.
Single scene only.
```
**结果**：生成角色在战场上的单一动作场景

---

## 💡 使用技巧

### 1. 参考图片选择
- ✅ **推荐**：清晰的正面照，五官清楚
- ✅ **推荐**：完整的服装展示
- ✅ **推荐**：风格统一（例如全是动漫风或全是写实风）
- ❌ **避免**：模糊、遮挡、侧面、背光

### 2. 批量生成策略
- **首次生成**：选择 9 个（一次性看到更多效果）
- **失败重试**：使用"重试失败项"功能
- **继续生成**：
  - 严格顺序：适合需要完整连续性的项目
  - 跳过失败：适合快速推进，后续单独处理失败项

### 3. 积分优化
- 使用开发者邮箱：无限积分（测试用）
- Flux Schnell：1 积分/张，速度快
- Flux 1.1 Pro：6 积分/张，质量高
- 批量生成前检查余额

---

## 🐛 故障排除

### 问题 1：仍然生成三视图
**可能原因**：浏览器缓存旧代码  
**解决方法**：
```bash
# 重启前后端
npm run dev:all

# 强制刷新浏览器
Mac: Cmd + Shift + R
Windows: Ctrl + Shift + R
```

### 问题 2：参考图片上传失败
**检查**：
1. 文件格式是否正确（JPG/PNG/WebP）
2. 文件大小是否超过 10MB
3. 后端日志是否有 Gemini API 错误
4. Gemini API Key 是否配置正确

### 问题 3：批量生成卡住
**检查**：
1. 查看浏览器 Console（F12）
2. 查看后端日志（terminal 输出）
3. 检查 Replicate API Token
4. 检查积分余额

---

## 📊 测试结果

### 测试项目
- 项目：Nezha vs. Sun Wukong
- 场景数：5
- 测试批量：9 个镜头

### 旧版结果（修复前）
- ❌ 所有图片都是角色三视图
- ❌ 没有场景动作
- ❌ 无法体现故事情节

### 新版结果（修复后）
- ✅ 每个镜头不同场景
- ✅ 角色在执行不同动作
- ✅ 角色外观保持一致
- ✅ 符合故事情节

---

## 🎯 下一步建议

1. **测试新功能**：
   - 尝试上传不同风格的角色图片
   - 批量生成 9 个镜头
   - 对比角色一致性

2. **调整参数**：
   - 尝试不同的模型（Flux vs Flux Schnell）
   - 调整批量数量（3/6/9/12）
   - 测试不同的继续策略

3. **反馈问题**：
   - 如果发现角色不一致，记录提示词
   - 如果生成失败，查看错误消息
   - 提供测试用例和期望结果

---

## 📞 技术支持

- **代码位置**：
  - 前端服务：`services/replicateService.ts`
  - 后端路由：`server/routes/gemini.ts`
  - 上传组件：`components/ReferenceImageUploader.tsx`
  - 批量面板：`components/BatchImagePanel.tsx`

- **诊断工具**：
  ```bash
  # 全面诊断
  npx tsx scripts/diagnose-all.ts
  
  # 查看日志
  tail -f server.log  # 后端日志
  ```

- **开发者邮箱**：forevercrab321@gmail.com
- **系统状态**：http://localhost:3002/api/health

---

**最后更新**：2026年2月23日  
**版本**：v1.1.0  
**状态**：✅ 所有功能正常运行
